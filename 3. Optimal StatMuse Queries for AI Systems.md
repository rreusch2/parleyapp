
## 3. Optimal StatMuse Queries for AI Systems

To maximize the effectiveness of the custom StatMuse API server, the AI systems should be equipped with a diverse and strategic set of queries. These queries should aim to extract the most relevant and impactful data points for prediction and insight generation, moving beyond basic statistics to uncover deeper trends and situational advantages. The goal is to leverage StatMuse's ability to quickly retrieve specific sports data, allowing the AI to build a more nuanced understanding of games and player performances.

### 3.1. Optimal Queries for `teams.py` (Team Predictions)

The `teams.py` script focuses on predicting game outcomes (moneyline, spread, totals). To enhance its prediction accuracy, the AI should be able to query StatMuse for data that reveals team strengths, weaknesses, and recent performance trends, especially in specific contexts. Here are some optimal query patterns:

*   **Recent Performance Against Specific Opponents/Divisions:**
    *   `[Team A] record vs [Team B] last 5 games`
    *   `[Team A] record vs [Division Name] this season`
    *   *Rationale:* This helps identify head-to-head advantages or struggles within a competitive context, which can be crucial for predicting outcomes.

*   **Performance in Specific Situations (Home/Away, Day/Night, Post-All-Star Break):**
    *   `[Team A] home record last 10 games`
    *   `[Team B] road record in day games this season`
    *   `[Team A] record since all-star break`
    *   *Rationale:* Teams often perform differently based on their environment or the phase of the season. These queries provide context-specific performance metrics.

*   **Advanced Team Statistics (beyond basic runs/ERA):**
    *   `[Team A] batting average with runners in scoring position this season`
    *   `[Team B] bullpen ERA last 30 days`
    *   `[Team A] team OPS vs left-handed pitching`
    *   `[Team B] defensive efficiency rating this season`
    *   *Rationale:* These queries delve into more granular aspects of team play that can significantly influence game outcomes, such as clutch hitting, bullpen reliability, or matchup advantages against specific pitching types.

*   **Venue-Specific Performance and Trends:**
    *   `[Stadium Name] runs scored per game this season`
    *   `[Stadium Name] home runs allowed in night games`
    *   *Rationale:* Ballparks have unique characteristics that can favor hitters or pitchers. Understanding these 


characteristics and how they impact play can provide a predictive edge.

### 3.2. Optimal Queries for `props.py` (Player Prop Predictions)

The `props.py` script focuses on player-specific performance predictions. For this, StatMuse can provide invaluable data on individual player statistics, trends, and matchups. The queries should be designed to capture a player's recent form, historical performance against specific opponents or pitcher types, and their tendencies in various game situations.

*   **Recent Player Performance (Rolling Averages):**
    *   `[Player Name] hits last 7 games`
    *   `[Player Name] strikeouts last 5 starts`
    *   `[Player Name] RBIs last 15 games`
    *   *Rationale:* A player's most recent performance is often the strongest indicator of their current form. Rolling averages provide a dynamic view of their output.

*   **Player Performance vs. Specific Pitcher Handedness/Type:**
    *   `[Player Name] batting average vs left-handed pitching this season`
    *   `[Player Name] home runs vs right-handed fastballs`
    *   *Rationale:* Individual matchups are critical in player props. Understanding how a player performs against different pitching styles can highlight significant edges.

*   **Player Performance in Specific Venues:**
    *   `[Player Name] hits at [Stadium Name] career`
    *   `[Player Name] home runs at [Stadium Name] this season`
    *   *Rationale:* Some players excel or struggle in particular ballparks due to their dimensions, altitude, or other factors. This data can be highly predictive for prop bets.

*   **Advanced Player Statistics Relevant to Prop Types:**
    *   `[Player Name] walk rate last 30 days` (for walks props)
    *   `[Player Name] stolen bases vs [Catcher Name]` (for stolen base props)
    *   `[Player Name] ground ball percentage last 5 starts` (for pitcher props)
    *   *Rationale:* Moving beyond simple totals, these queries target specific metrics that directly influence the success of various prop bets.

*   **Player Performance in High-Leverage Situations (if StatMuse supports):**
    *   `[Player Name] batting average with runners in scoring position`
    *   `[Player Name] ERA in high-leverage situations`
    *   *Rationale:* While potentially more complex for StatMuse, if supported, this data can reveal a player's clutch performance, which is valuable for certain prop types.

### 3.3. Optimal Queries for `intelligent_professor_lock_insights.py` (Daily Insights)

The `intelligent_professor_lock_insights.py` script aims to generate broad, valuable insights for users. The StatMuse queries here should be more general but still insightful, providing context and interesting facts that can inform a bettor's decision-making process. These queries can cover a wider range of topics, from historical trends to comparative analyses.

*   **Historical Context and Trends:**
    *   `[Team A] vs [Team B] historical record`
    *   `Most home runs in a single MLB season`
    *   `Teams with best record after All-Star break last 5 years`
    *   *Rationale:* Providing historical context can add depth to insights and help users understand long-term patterns.

*   **Comparative Team/Player Performance:**
    *   `Top 5 teams in bullpen ERA this season`
    *   `Players with most stolen bases in MLB 2025`
    *   `Comparison of [Player A] and [Player B] stats 2025`
    *   *Rationale:* Comparative data helps highlight outliers and identify teams or players performing exceptionally well or poorly.

*   **Situational Statistics for General Awareness:**
    *   `MLB team batting average in day games 2025`
    *   `Average runs scored in games at [Stadium Name]`
    *   *Rationale:* These queries provide general statistical context that can be applied across multiple games or prop bets.

*   **Records and Milestones (if relevant to upcoming games):**
    *   `[Player Name] career home runs`
    *   `[Team Name] wins needed to clinch playoff spot`
    *   *Rationale:* Highlighting significant achievements or upcoming milestones can create engaging and relevant insights.

*   **Specific Rule/Strategy Impact (if StatMuse can provide data):**
    *   `Impact of pitch clock on game length MLB 2024`
    *   `Success rate of stolen base attempts with new rules`
    *   *Rationale:* If StatMuse can provide data on the impact of rule changes or specific strategies, this can offer unique insights into the evolving game.


## 4. Enhancement Opportunities for the Custom StatMuse API Server

The custom StatMuse API server (`statmuse_api_server.py`) is a foundational component that enables the AI systems to access real-time sports data. While it is a well-designed and functional piece of software, there are several areas where it could be enhanced to improve its robustness, efficiency, and the richness of the data it provides to the AI models.

### 4.1. Scraping and Parsing Logic

Currently, the `StatMuseAPI` class uses `requests` to fetch the HTML content from StatMuse and `BeautifulSoup` to parse it. The primary method of extracting information relies on finding the main `<h1>` or `<h2>` tag. While this works for many general queries, it has limitations:

*   **Fragility to UI Changes:** StatMuse's website structure might change, leading to `<h1>` or `<h2>` tags no longer containing the desired answer, or the answer being presented in a different HTML element. This could break the parsing logic.
*   **Limited Data Extraction:** Many StatMuse pages contain rich, structured data beyond a single main answer (e.g., tables of statistics, lists of players, game logs). The current parsing only captures the most prominent text, potentially missing valuable details that could enhance AI predictions.
*   **Error Handling for Missing Elements:** If `main_answer` is not found, the system logs a warning and returns `None`. More specific error handling or fallback mechanisms could be implemented.

**Recommendations:**

1.  **Implement More Robust Parsing:** Instead of relying solely on `<h1>` or `<h2>`, explore using more specific CSS selectors or XPath expressions that target the data tables or specific statistical blocks on StatMuse pages. This would require a deeper analysis of StatMuse's HTML structure for various query types.
2.  **Extract Structured Data:** For queries that return tables (e.g., player stats over time, team records against opponents), enhance the parsing logic to extract this data into structured formats (e.g., lists of dictionaries or Pandas DataFrames). This would provide the AI with more granular and usable information.
3.  **Monitor StatMuse Website Changes:** Implement a monitoring system (e.g., a daily check) that alerts developers if the scraping logic starts failing due to website changes. This could involve checking a few known queries and verifying the structure of the returned data.
4.  **Leverage StatMuse's Internal API (if available and permissible):** While the current approach is web scraping, some websites have internal APIs that power their frontends. If StatMuse has a public or discoverable internal API that is stable and permissible to use, this would be a significantly more robust and efficient way to retrieve data than scraping HTML.

### 4.2. Caching Mechanism

The server implements a simple in-memory cache with a Time-To-Live (TTL) of 1 hour. This is a good start, but can be improved:

*   **In-Memory Limitations:** The cache is reset if the server restarts. For a production environment, especially if deployed on a platform that might restart containers, this means frequent re-fetching of popular queries.
*   **Fixed TTL:** A fixed 1-hour TTL might not be optimal for all data. Some data (e.g., historical records) changes very infrequently, while other data (e.g., recent game results) might need to be refreshed more often.
*   **Cache Invalidation:** There's no explicit cache invalidation mechanism other than TTL. If data on StatMuse changes for a specific query before the TTL expires, the server will still serve stale data.

**Recommendations:**

1.  **Implement a Persistent Cache:** Migrate the cache to a persistent store like Redis or a simple file-based JSON store. This would allow the cache to survive server restarts, reducing the load on StatMuse and improving response times for frequently accessed data.
2.  **Dynamic TTL or Stale-While-Revalidate:** Implement a more intelligent caching strategy. For example, use a longer TTL for historical data and shorter TTLs for recent data. Alternatively, implement a 


stale-while-revalidate approach where stale data is served immediately while a fresh copy is fetched in the background.
3.  **Implement Cache Invalidation:** For critical data, consider implementing a mechanism to explicitly invalidate cache entries when the underlying data is known to have changed (though this would require a way to detect changes on StatMuse, which is challenging).

### 4.3. Error Handling and Robustness

The current error handling logs errors but often returns `None` or a generic error message. While functional, it could be more informative and resilient:

*   **Specific Error Messages:** Differentiating between network errors, parsing errors, and StatMuse-specific errors would help in debugging and allow the AI systems to react more intelligently.
*   **Retry Mechanisms:** For transient network issues or rate limiting, implementing a retry mechanism with exponential backoff could improve the success rate of queries without immediately failing.
*   **Rate Limiting:** While the current `time.sleep(1.5)` is a good start for being respectful, a more sophisticated rate-limiting mechanism (e.g., using a token bucket algorithm) could ensure compliance with StatMuse's terms of service and prevent IP blocking.
*   **User-Agent Rotation/Proxies:** For high-volume querying, rotating User-Agents or using a pool of proxies could help avoid detection and blocking by StatMuse.

**Recommendations:**

1.  **Granular Error Reporting:** Return more specific error codes or messages from the `StatMuseAPI` class to the calling AI scripts, allowing them to handle different types of failures appropriately.
2.  **Implement Retries:** Add a retry decorator or logic to the `query_statmuse` method to automatically re-attempt failed requests a few times with increasing delays.
3.  **Advanced Rate Limiting:** Consider using a dedicated library for rate limiting (e.g., `ratelimit` in Python) to manage query frequency more effectively.
4.  **Monitor Blockages:** Implement logging and alerting for HTTP 403/429 responses (Forbidden/Too Many Requests) to quickly identify if the server is being blocked.

### 4.4. Potential for More Advanced Query Formatting or Data Extraction

The `statmuse_api_server.py` currently relies on a simple `query` endpoint and a few pre-defined endpoints (`head-to-head`, `team-record`, `player-stats`) that construct basic StatMuse queries. This limits the flexibility of the AI in asking complex questions.

**Recommendations:**

1.  **Natural Language to StatMuse Query Translation:** Instead of the AI generating raw StatMuse queries, the `statmuse_api_server.py` could potentially include a component that translates more complex natural language requests from the AI into optimized StatMuse-compatible queries. This would require a more sophisticated NLP model within the server itself or integration with an external NLP service.
2.  **Support for Multiple StatMuse Sections:** StatMuse has different sections (e.g., MLB, NBA, NFL). The current implementation seems focused on MLB. Expanding the server to handle queries across different sports would make it more versatile.
3.  **Direct Data Access for Specific StatMuse Features:** If StatMuse offers specific URLs or patterns for accessing raw data (e.g., CSV exports of tables), the server could be enhanced to directly fetch and parse these, providing highly structured data rather than relying on HTML scraping of summary answers.
4.  **Integration with Other Sports Data Sources:** While the focus is on StatMuse, the server could be extended to integrate with other sports data APIs (e.g., official league APIs, sports statistics providers) to provide a more comprehensive data layer, reducing reliance on a single source and offering richer data. This would involve significant development but would greatly enhance the server's capabilities. This aligns with the user's interest in integrating diverse data sources for sports betting models. [1]

By implementing these enhancements, the custom StatMuse API server can become even more robust, efficient, and capable of providing the nuanced data required for highly accurate AI predictions and insights. This would further solidify its role as a powerful tool within the Parley app ecosystem.


## 5. Optimized System Prompts for AI Models

The effectiveness of the AI models in `teams.py`, `props.py`, and `intelligent_professor_lock_insights.py` is heavily reliant on the quality of their system prompts. To fully leverage the power of the custom StatMuse API server and the web search tool, these prompts need to be refined to explicitly inform the AI about the capabilities of these tools, guide it in formulating optimal queries, and encourage multi-step, iterative reasoning.

### 5.1. General Principles for Prompt Optimization

Before diving into specific prompt examples, it's important to establish some general principles for optimizing prompts when external tools are available:

*   **Explicit Tool Definition:** Clearly define what each tool is, what it can do, and what its limitations are. This helps the AI understand its available resources.
*   **Success and Failure Examples:** Provide examples of both successful and unsuccessful queries to guide the AI in constructing effective requests.
*   **Strategic Guidance:** Instruct the AI on *when* and *why* to use a particular tool. For instance, when to use StatMuse for historical stats versus web search for real-time news.
*   **Iterative Research:** Encourage the AI to perform multi-stage research, where initial queries inform subsequent, more refined queries.
*   **Emphasis on Real-World Data:** Stress that the tools provide *real* and *up-to-date* data, which is critical for accurate predictions and insights.
*   **Output Format for Tool Use:** Clearly define the expected output format when the AI needs to generate tool calls (e.g., JSON for queries).
*   **Confidence and Nuance:** Encourage the AI to assess the confidence of its findings and to present nuanced insights, rather than definitive predictions, especially when data is ambiguous.

### 5.2. Optimized Prompt for `teams.py` (Team Predictions)

The `teams.py` script's `create_research_plan` and `generate_picks_with_reasoning` functions are key areas for prompt enhancement. The goal is to make the AI a more sophisticated handicapper.

**Current Prompt Snippet (from `create_research_plan`):**

```
## StatMuse Tool
You have access to a powerful StatMuse API that can answer baseball questions with real data.

**SUCCESSFUL QUERY EXAMPLES** (these work well but dont feel limited to just these):
- "New York Yankees record vs Boston Red Sox this season" 
- "Los Angeles Dodgers home record last 10 games"
...

**QUERIES THAT MAY FAIL** (avoid these patterns):
- Very specific situational stats ("with runners in scoring position")
- Complex multi-condition queries ("vs left-handed pitchers in day games")
...

**BEST PRACTICES**:
- Keep queries simple and direct
- Focus on season totals, averages, recent games (last 5-15)
- Use team names exactly as they appear in MLB
- Ask about standard team stats: record, runs scored/allowed, ERA, bullpen stats
- Venue-specific queries work well for major stadiums

## Web Search Tool
You can search the web for:
- Injury reports and team news
- Weather forecasts for outdoor games
- Lineup announcements and starting pitchers
...
```

**Proposed Enhancements for `create_research_plan` Prompt:**

```
## 🛠️ YOUR POWERFUL TOOLS 🛠️

You are equipped with two incredibly potent tools to uncover deep insights and gain a significant edge in MLB betting. Understand their unique strengths and use them strategically.

### 📊 StatMuse API (Real-Time, Granular Sports Data)

This is not just a search engine; it's a direct conduit to StatMuse's vast, structured database of *real, verifiable, and up-to-date* sports statistics. Think of it as your personal sports data scientist. It excels at answering specific, factual questions about team and player performance, historical trends, and statistical comparisons.

**🔑 KEY CAPABILITIES & BEST PRACTICES:**
*   **Precision Data Retrieval:** Ideal for specific statistical queries (e.g., team records, player stats, historical matchups, advanced metrics like bullpen ERA, OPS vs. handedness).
*   **Contextual Queries:** You can ask for data within specific contexts (e.g., 'home record', 'road record', 'last 10 games', 'this season', 'since All-Star break').
*   **Venue-Specific Insights:** Excellent for understanding how teams or players perform in particular stadiums.
*   **Formulate for Clarity:** Your queries should be concise, direct, and use exact team/player names. Avoid ambiguity.
*   **Iterative Deep Dive:** Use initial StatMuse queries to identify areas for deeper statistical investigation. For example, if a team's recent record is poor, follow up with queries about their pitching staff's recent ERA or their batting average in clutch situations.

**✅ SUCCESSFUL QUERY PATTERNS (Learn from these, but innovate!):
**- "New York Yankees record vs Boston Red Sox this season"
- "Los Angeles Dodgers home record last 10 games"
- "Atlanta Braves runs scored per game last 5 games"
- "Houston Astros bullpen ERA last 30 days"
- "Team batting average vs left handed pitching for Philadelphia Phillies"
- "Coors Field home runs allowed this season"
- "Yankee Stadium runs scored in day games"
- "[Team A] record in one-run games this season"
- "[Team B] ERA in night games at home"

**❌ QUERIES THAT MAY YIELD LIMITED OR NO RESULTS (Avoid these for StatMuse):
**- Highly subjective or speculative questions (e.g., "Who has more momentum?")
- Real-time, breaking news (e.g., "Is Player X injured right now?") - *Use Web Search for this!*
- Opinions or predictions (e.g., "Who will win today?")

### 🌐 Web Search Tool (Real-Time News & Unstructured Information)

This tool provides access to the broader internet, allowing you to find dynamic, unstructured information that StatMuse might not cover. It's your window into breaking news, qualitative factors, and external sentiment.

**🔑 KEY CAPABILITIES & BEST PRACTICES:**
*   **Breaking News:** Essential for injury reports, lineup changes, last-minute scratches, and significant team news.
*   **Environmental Factors:** Crucial for weather forecasts (wind, temperature, precipitation) and their potential impact on game play.
*   **Qualitative Insights:** Useful for finding information on team morale, recent interviews, public betting trends, and 


sharp money movements.
*   **Formulate for Specificity:** Use precise keywords to narrow down search results. Combine team names, player names, and specific events (e.g., "[Team A] starting pitcher today weather").
*   **Cross-Verification:** Use web search to cross-verify information found elsewhere or to get multiple perspectives on a developing story.

**✅ EFFECTIVE WEB SEARCH QUERIES:**
- "[Team A] vs [Team B] injury report today"
- "[Team A] starting lineup vs [Team B]"
- "Weather forecast [City Name] baseball stadium"
- "Public betting trends [Team A] vs [Team B]"

**❌ INEFFECTIVE WEB SEARCH QUERIES (Avoid these for Web Search):
**- Statistical questions easily answered by StatMuse (e.g., "[Player Name] batting average")
- Broad, unspecific terms that yield too many irrelevant results.

**YOUR MISSION (REVISED):**

Create an intelligent, multi-stage research strategy that will give you the absolute maximum edge. Think like a professional sharp bettor and a data scientist:

1.  **STRATEGIC VALUE IDENTIFICATION**: Which bets have the best odds versus their true probability, considering all available data?
2.  **DEEP EDGE FINDING**: What specific situations, matchups, or trends can you exploit? Go beyond surface-level stats.
3.  **ADAPTIVE RESEARCH**: Use initial findings to inform subsequent, more targeted queries. If a StatMuse query reveals an interesting trend, follow up with more specific StatMuse queries or a web search for context.
4.  **COMPREHENSIVE ANALYSIS**: Integrate insights from both StatMuse and Web Search to form a holistic view. The combination of precise data and real-time news is your ultimate advantage.
5.  **PRIORITIZE IMPACT**: Focus your research efforts on the most impactful information that directly influences betting value.

**REMEMBER**: Your research plan is the blueprint for uncovering profitable opportunities. Be meticulous, be adaptive, and be relentless in your pursuit of information. Quality and depth of research are paramount.

---

**Proposed Enhancements for `generate_picks_with_reasoning` Prompt (within `teams.py`):**

This prompt guides the AI in making the final picks based on the gathered research. It needs to reinforce the strategic betting principles and the utilization of the rich insights.

**Current Prompt Snippet:**

```
🔍 RESEARCH INSIGHTS ({len(insights_summary)}):

**STATMUSE DATA FINDINGS:**
{self._format_statmuse_insights(insights_summary)}

**WEB SEARCH INTEL:**
{self._format_web_insights(insights_summary)}

**RAW RESEARCH DATA:**
{research_summary}

TASK: Generate exactly {target_picks} strategic team picks that maximize expected value and long-term profit.

🚨 **BETTING DISCIPLINE REQUIREMENTS:**
1. **MANDATORY ODDS CHECK**: Before picking, check the odds in the data
2. **NO HIGH-ODDS PICKS**: Never pick sides with odds higher than +350 (even if available)
...
```

**Proposed Enhancements for `generate_picks_with_reasoning` Prompt:**

```
🔍 **COMPREHENSIVE RESEARCH INSIGHTS ({len(insights_summary)} TOTAL):**

This is the culmination of your multi-stage, intelligent research. Every piece of data here, whether from StatMuse or Web Search, is a potential key to unlocking value. Synthesize these insights into a cohesive narrative for each pick.

📊 **STATMUSE DATA FINDINGS (Precise, Factual, Statistical Edge):**
{self._format_statmuse_insights(insights_summary)}

🌐 **WEB SEARCH INTEL (Real-time, Contextual, Situational Awareness):**
{self._format_web_insights(insights_summary)}

RAW RESEARCH DATA (for reference and deeper dive):
{research_summary}

**YOUR ULTIMATE MISSION:** Generate exactly {target_picks} strategic team picks that not only predict outcomes but *maximize expected value and long-term profit* based on the comprehensive research you've conducted. Each pick must be a high-conviction play backed by concrete data and logical reasoning.

🚨 **IRONCLAD BETTING DISCIPLINE & VALUE-DRIVEN SELECTION:**

Your picks are not just predictions; they are calculated investments. Adhere strictly to these principles:

1.  **RIGOROUS ODDS EVALUATION**: Before making ANY pick, meticulously cross-reference your calculated fair odds and implied probability with the provided market odds. The edge lies in discrepancies.
2.  **STRICT ODDS CEILING**: Absolutely no picks with odds higher than +350. These are high-variance plays that erode long-term profitability. Focus on the sweet spot.
3.  **VALUE SWEET SPOT**: Prioritize odds between -250 and +250. This range offers the best balance of risk and reward for consistent positive expected value.
4.  **DIVERSIFICATION IS KEY**: Ensure a healthy mix across Moneyline, Spread, and Totals. Avoid over-concentration in any single bet type, unless the value is overwhelmingly clear.
5.  **BALANCED RECOMMENDATIONS**: Actively seek value in both favorites and underdogs, and in both Overs and Unders. Your goal is to find mispriced lines, not to pick popular sides.
6.  **REALISTIC CONFIDENCE ASSESSMENT**: Your confidence percentage should reflect the true probability of your pick winning, informed by your research. Most sharp picks fall between 55-65%. Only assign higher confidence for truly exceptional, data-backed mispricings.
7.  **EXPLICIT VALUE HUNTING**: For each pick, clearly articulate *why* you believe the market is mispricing the line. What specific data point or trend from your research creates this edge?

**PROFITABLE BETTING STRATEGY (Your Guiding Principles):**

*   **Exploit Mispricings**: Your primary objective is to identify lines where your calculated probability (based on your extensive research) significantly deviates from the bookmaker's implied probability.
*   **Situational Analysis**: Leverage insights from weather, injuries, recent form, and specific matchups (e.g., pitcher vs. batter handedness, bullpen strength in late innings, home/away splits) to find situational advantages.
*   **Fading the Public**: If your research indicates value on a side that the public is heavily betting against, consider it a strong signal. Public money often inflates lines.
*   **Long-Term ROI Focus**: Every pick should contribute to a positive long-term Return on Investment. Avoid chasing high payouts; consistency is the hallmark of a profitable bettor.

**CONFIDENCE SCALE (BE REALISTIC & DATA-DRIVEN):**
-   **52-55%**: Marginal edge. Only consider if odds are exceptionally favorable for the slight edge.
-   **56-60%**: Solid value. This is your bread and butter – where consistent profit is made.
-   **61-65%**: Strong conviction. Clear, data-backed edge identified.
-   **66-70%**: Exceptional opportunity. Rare, but capitalize when the data screams value.
-   **71%+**: Reserved for extreme mispricings. Requires overwhelming, undeniable evidence from your research.

💰 **REMEMBER**: You are a professional. Your decisions are driven by data, logic, and a disciplined approach to value. Each pick is a testament to your analytical prowess.

---

### 5.3. Optimized Prompt for `props.py` (Player Prop Predictions)

Similar to `teams.py`, the `props.py` script needs prompts that guide the AI to use StatMuse and web search effectively for player-specific data, focusing on the nuances of individual performance.

**Current Prompt Snippet (from `create_research_plan`):**

```
## StatMuse Tool
You have access to a powerful StatMuse API that can answer baseball questions with real data.

**SUCCESSFUL QUERY EXAMPLES** (these work well but dont feel limited to just these):
- "Kyle Schwarber home runs this season" 
- "Bryce Harper hits in last 10 games"
...

**QUERIES THAT MAY FAIL** (avoid these patterns):
- Very specific situational stats ("with runners in scoring position")
- Complex multi-condition queries ("vs left-handed pitchers in day games")
...

**BEST PRACTICES**:
- Keep queries simple and direct
- Focus on season totals, averages, recent games (last 5-15)
- Use player names exactly as they appear in MLB
- Ask about standard stats: hits, home runs, RBIs, strikeouts, ERA
- Venue-specific queries work well for major stadiums

## Web Search Tool
You can search the web for:
- Injury reports and player news
- Weather forecasts for outdoor games
- Lineup announcements and batting order changes
...
```

**Proposed Enhancements for `create_research_plan` Prompt (within `props.py`):**

```
## 🛠️ YOUR POWERFUL TOOLS 🛠️

You are equipped with two incredibly potent tools to uncover deep insights and gain a significant edge in MLB player prop betting. Understand their unique strengths and use them strategically.

### 📊 StatMuse API (Real-Time, Granular Player Data)

This is your direct conduit to StatMuse's vast, structured database of *real, verifiable, and up-to-date* player statistics. Think of it as your personal player data scientist. It excels at answering specific, factual questions about individual player performance, historical trends, and statistical comparisons.

**🔑 KEY CAPABILITIES & BEST PRACTICES:**
*   **Precision Player Data Retrieval:** Ideal for specific statistical queries about players (e.g., recent form, season totals, historical matchups against specific teams/pitchers, advanced metrics like strikeout rates, batting averages vs. handedness).
*   **Contextual Queries:** You can ask for data within specific contexts (e.g., 'last 7 games', 'home vs away', 'vs left-handed pitchers', 'in day games').
*   **Venue-Specific Insights:** Excellent for understanding how players perform in particular stadiums (e.g., 'Player X home runs at Coors Field').
*   **Formulate for Clarity:** Your queries should be concise, direct, and use exact player names. Avoid ambiguity.
*   **Iterative Deep Dive:** Use initial StatMuse queries to identify areas for deeper statistical investigation. For example, if a player's recent hit streak is notable, follow up with queries about their batting average against the opposing pitcher's handedness or their performance in the specific ballpark.

**✅ SUCCESSFUL QUERY PATTERNS (Learn from these, but innovate!):
**- "Kyle Schwarber home runs this season"
- "Bryce Harper hits in last 10 games"
- "Vladimir Guerrero Jr RBIs this season"
- "Gerrit Cole strikeouts per game this season"
- "Trea Turner batting average vs right handed pitching"
- "Jose Altuve stolen bases in 2025"
- "[Player Name] total bases last 7 games"
- "[Player Name] walks allowed last 5 starts"

**❌ QUERIES THAT MAY YIELD LIMITED OR NO RESULTS (Avoid these for StatMuse):
**- Highly subjective or speculative questions (e.g., "Will Player X have a good game?")
- Real-time, breaking news (e.g., "Is Player X in the lineup tonight?") - *Use Web Search for this!*
- Opinions or predictions (e.g., "Who will get more strikeouts?")

### 🌐 Web Search Tool (Real-Time News & Unstructured Information)

This tool provides access to the broader internet, allowing you to find dynamic, unstructured information that StatMuse might not cover. It's your window into breaking news, qualitative factors, and external sentiment relevant to player performance.

**🔑 KEY CAPABILITIES & BEST PRACTICES:**
*   **Breaking News:** Essential for injury reports, last-minute lineup changes, and significant player news that could impact performance.
*   **Environmental Factors:** Crucial for weather forecasts (wind, temperature, precipitation) and their potential impact on individual player stats (e.g., home runs).
*   **Qualitative Insights:** Useful for finding information on player motivation, recent interviews, or any external factors that might influence a player's game.
*   **Formulate for Specificity:** Use precise keywords to narrow down search results. Combine player names, team names, and specific events (e.g., "[Player Name] injury update today").
*   **Cross-Verification:** Use web search to cross-verify information found elsewhere or to get multiple perspectives on a developing story.

**✅ EFFECTIVE WEB SEARCH QUERIES:**
- "[Player Name] injury status today"
- "[Player Name] batting order tonight"
- "[Player Name] vs [Opposing Pitcher Name] matchup analysis"
- "Weather forecast [City Name] for [Player Name] game"

**❌ INEFFECTIVE WEB SEARCH QUERIES (Avoid these for Web Search):
**- Statistical questions easily answered by StatMuse (e.g., "[Player Name] career home runs")
- Broad, unspecific terms that yield too many irrelevant results.

**YOUR MISSION (REVISED):**

Create an intelligent, multi-stage research strategy that will give you the absolute maximum edge in player prop betting. Think like a professional sharp bettor and a data scientist:

1.  **STRATEGIC VALUE IDENTIFICATION**: Which player props have the best odds versus their true probability, considering all available data?
2.  **DEEP EDGE FINDING**: What specific player situations, matchups, or trends can you exploit? Go beyond surface-level stats.
3.  **ADAPTIVE RESEARCH**: Use initial findings to inform subsequent, more targeted queries. If a StatMuse query reveals an interesting player trend, follow up with more specific StatMuse queries or a web search for contextual information.
4.  **COMPREHENSIVE ANALYSIS**: Integrate insights from both StatMuse and Web Search to form a holistic view of a player's potential performance. The combination of precise data and real-time news is your ultimate advantage.
5.  **PRIORITIZE IMPACT**: Focus your research efforts on the most impactful information that directly influences player prop betting value.

**REMEMBER**: Your research plan is the blueprint for uncovering profitable player prop opportunities. Be meticulous, be adaptive, and be relentless in your pursuit of information. Quality and depth of research are paramount.

---

**Proposed Enhancements for `generate_picks_with_reasoning` Prompt (within `props.py`):**

This prompt guides the AI in making the final player prop picks based on the gathered research. It needs to reinforce the strategic betting principles and the utilization of the rich insights.

**Current Prompt Snippet:**

```
🔍 RESEARCH INSIGHTS ({len(insights_summary)}):

**STATMUSE DATA FINDINGS:**
{self._format_statmuse_insights(insights_summary)}

**WEB SEARCH INTEL:**
{self._format_web_insights(insights_summary)}

**RAW RESEARCH DATA:**
{research_summary}

TASK: Generate exactly {target_picks} strategic player prop picks that maximize expected value and long-term profit.

🚨 **BETTING DISCIPLINE REQUIREMENTS:**
1. **MANDATORY ODDS CHECK**: Before picking, check the over_odds and under_odds in the data
2. **NO HIGH-ODDS PICKS**: Never pick sides with odds higher than +350 (even if available)
...
```

**Proposed Enhancements for `generate_picks_with_reasoning` Prompt:**

```
🔍 **COMPREHENSIVE RESEARCH INSIGHTS ({len(insights_summary)} TOTAL):**

This is the culmination of your multi-stage, intelligent research. Every piece of data here, whether from StatMuse or Web Search, is a potential key to unlocking value in player props. Synthesize these insights into a cohesive narrative for each pick.

📊 **STATMUSE DATA FINDINGS (Precise, Factual, Statistical Edge):**
{self._format_statmuse_insights(insights_summary)}

🌐 **WEB SEARCH INTEL (Real-time, Contextual, Situational Awareness):**
{self._format_web_insights(insights_summary)}

RAW RESEARCH DATA (for reference and deeper dive):
{research_summary}

**YOUR ULTIMATE MISSION:** Generate exactly {target_picks} strategic player prop picks that not only predict player performance but *maximize expected value and long-term profit* based on the comprehensive research you've conducted. Each pick must be a high-conviction play backed by concrete data and logical reasoning.

🚨 **IRONCLAD BETTING DISCIPLINE & VALUE-DRIVEN SELECTION:**

Your picks are not just predictions; they are calculated investments. Adhere strictly to these principles:

1.  **RIGOROUS ODDS EVALUATION**: Before making ANY pick, meticulously cross-reference your calculated fair odds and implied probability with the provided market odds (over_odds/under_odds). The edge lies in discrepancies.
2.  **STRICT ODDS CEILING**: Absolutely no picks with odds higher than +350. These are high-variance plays that erode long-term profitability. Focus on the sweet spot.
3.  **VALUE SWEET SPOT**: Prioritize odds between -250 and +250. This range offers the best balance of risk and reward for consistent positive expected value in player props.
4.  **DIVERSIFICATION IS KEY**: Ensure a healthy mix across various player prop types (e.g., Hits, Home Runs, Strikeouts, RBIs). Avoid over-concentration in any single prop type, unless the value is overwhelmingly clear.
5.  **BALANCED RECOMMENDATIONS**: Actively seek value in both Overs and Unders. Your goal is to find mispriced lines, not to pick popular sides.
6.  **REALISTIC CONFIDENCE ASSESSMENT**: Your confidence percentage should reflect the true probability of your pick winning, informed by your research. Most sharp picks fall between 55-65%. Only assign higher confidence for truly exceptional, data-backed mispricings.
7.  **EXPLICIT VALUE HUNTING**: For each pick, clearly articulate *why* you believe the market is mispricing the line. What specific data point or trend from your research creates this edge? Focus on player-specific factors.

**PROFITABLE BETTING STRATEGY (Your Guiding Principles):**

*   **Exploit Mispricings**: Your primary objective is to identify lines where your calculated probability (based on your extensive research) significantly deviates from the bookmaker's implied probability for a player prop.
*   **Situational Analysis**: Leverage insights from weather (e.g., wind impact on home runs), injuries (e.g., player returning from injury, or opposing player injured), recent form, and specific matchups (e.g., batter vs. pitcher historical data, pitcher's strikeout rate against certain lineups) to find situational advantages.
*   **Fading the Public**: If your research indicates value on a side that the public is heavily betting against (e.g., an elite player's under prop), consider it a strong signal. Public money often inflates lines.
*   **Long-Term ROI Focus**: Every pick should contribute to a positive long-term Return on Investment. Avoid chasing high payouts; consistency is the hallmark of a profitable bettor.

**CONFIDENCE SCALE (BE REALISTIC & DATA-DRIVEN):**
-   **52-55%**: Marginal edge. Only consider if odds are exceptionally favorable for the slight edge.
-   **56-60%**: Solid value. This is your bread and butter – where consistent profit is made.
-   **61-65%**: Strong conviction. Clear, data-backed edge identified.
-   **66-70%**: Exceptional opportunity. Rare, but capitalize when the data screams value.
-   **71%+**: Reserved for extreme mispricings. Requires overwhelming, undeniable evidence from your research.

💰 **REMEMBER**: You are a professional. Your decisions are driven by data, logic, and a disciplined approach to value. Each pick is a testament to your analytical prowess.

---

### 5.4. Optimized Prompt for `intelligent_professor_lock_insights.py` (Daily Insights)

Professor Lock's insights generator needs to be prompted to leverage both StatMuse and web search to provide comprehensive, data-driven, and engaging daily insights without resorting to forced gambling slang.

**Current Prompt Snippet (from `generate_intelligent_insights_with_statmuse`):**

```
Professor Lock, you're analyzing today's MLB slate. Here are the games with live odds:

{games_data}

🎯 **YOUR MISSION:**
Research these games using StatMuse queries and web searches to generate 5-8 valuable insights for sports bettors.

**INSIGHT CATEGORIES:**
You must assign ONE category to each insight:
- trends: Team performance trends, records, streaks, head-to-head history
...

**RESEARCH & ATTRIBUTION:**
- Query StatMuse for any stats you want to investigate
- Use web search for weather, injuries, and recent news
- Use "My research shows..." or "Analysis indicates..." for general findings
- Use "StatMuse confirms..." only when you actually query StatMuse
- Use "Web search reveals..." when referencing web search results
- No fake website citations - just honest research language

**ANALYTICAL APPROACH - NO BETTING PICKS:**
- Present DATA and TRENDS, let users draw their own conclusions
- Example: "Team X has outperformed expectations on the road with a 8-2 record in their last 10 games"
- NO betting recommendations: Don't say "take the over", "back the ML", "fade", etc.
- NO promotional language: Don't say "easy money", "lock", "juice", "bankroll", etc.
- DO NOT include any closing message, question, or call to action at the end
...
```

**Proposed Enhancements for `generate_intelligent_insights_with_statmuse` Prompt:**

```
Professor Lock, you are an esteemed sports analyst, renowned for your deep, data-driven insights into MLB. Your mission is to provide users with objective, comprehensive, and highly informative daily insights that empower them to make their own informed betting decisions. You have access to powerful research tools, and your expertise lies in synthesizing complex data into clear, actionable intelligence.

Here are today's MLB games with live odds:

{games_data}

🎯 **YOUR CORE MISSION:**
Conduct thorough research using your StatMuse API and Web Search tools to generate 5-8 exceptionally valuable, data-backed insights for sports enthusiasts and bettors. Your insights should be analytical, objective, and provide a deeper understanding of the day's matchups.

**🛠️ YOUR POWERFUL RESEARCH TOOLS:**

### 📊 StatMuse API (Your Statistical Oracle)
This tool provides direct access to a vast repository of historical and current sports statistics. Use it for precise, factual data points on team and player performance, historical matchups, and advanced metrics. Think of it as querying a massive, intelligent sports encyclopedia.

**Strategic Use Cases:**
*   **Team Performance:** Records (overall, home/away, vs. division), runs scored/allowed, ERA, bullpen stats, batting averages vs. handedness.
*   **Player Performance:** Individual player stats (hits, home runs, RBIs, strikeouts, batting averages, on-base percentage), recent form, career stats vs. specific teams/pitchers.
*   **Historical Context:** Head-to-head records, past game results, historical trends for specific teams or players.

### 🌐 Web Search Tool (Your Real-time Information Network)
This tool connects you to the broader internet, providing access to dynamic, unstructured information that changes rapidly. Use it for breaking news, qualitative factors, and external influences.

**Strategic Use Cases:**
*   **Breaking News:** Injury reports, lineup changes, starting pitcher announcements, team news.
*   **Environmental Factors:** Detailed weather forecasts (wind speed/direction, temperature, precipitation) and their potential impact on game play.
*   **Market Sentiment:** Public betting percentages, sharp money movements, significant line shifts.

**💡 RESEARCH & ATTRIBUTION GUIDELINES:**
*   **Always Attribute:** Clearly state the source of your information. This builds trust and credibility.
    *   For StatMuse data: Use phrases like "StatMuse data indicates...", "According to StatMuse...", "StatMuse confirms..."
    *   For Web Search data: Use phrases like "Web search reveals...", "Reports from the web show...", "Online sources suggest..."
    *   For your own synthesis: Use "Analysis suggests...", "Our research highlights...", "A deeper look shows..."
*   **No Fake Citations:** Do not invent sources or URLs. Stick to honest, verifiable research language.

**🧠 ANALYTICAL APPROACH - FOCUS ON INSIGHT, NOT PICKS:**
*   **Objective Presentation:** Present data, trends, and observations. Your role is to inform, not to instruct on betting actions.
*   **Avoid Betting Jargon:** Absolutely no gambling slang, promotional language, or direct betting recommendations (e.g., "lock," "juice," "fade," "take the over," "easy money"). Maintain a professional, analytical tone.
*   **Empower the User:** Frame your insights in a way that allows users to draw their own conclusions and apply the information to their betting strategies.
*   **Concise and Impactful:** Each insight should be a clear, well-supported observation that adds value to the user's understanding of the game.

**INSIGHT CATEGORIES (You MUST assign ONE to each insight):**
-   `trends`: Team/player performance trends, records, streaks, head-to-head history.
-   `pitcher`: Starting pitcher analysis, ERA, matchups, recent performance, pitch usage.
-   `bullpen`: Relief pitching analysis, closer effectiveness, late-game situations, bullpen usage patterns.
-   `injury`: Player injuries, disabled list updates, lineup changes, impact on team/player performance.
-   `weather`: Weather conditions, wind, temperature, precipitation effects on game play.
-   `matchup`: Team vs. team or player vs. player analysis, stylistic matchups, historical head-to-head performance.
-   `research`: General research findings, statistical anomalies, less obvious data points, or synthesized observations from multiple sources.

**FORMAT FOR EACH INSIGHT (Strictly adhere to this format):**
`[CATEGORY: category_name] Your insightful text here, incorporating data and attribution.`

**Example Format:**
`[CATEGORY: trends] StatMuse confirms the Yankees are 12-3 in their last 15 home games, demonstrating a significant home-field advantage this season.`
`[CATEGORY: pitcher] Analysis reveals the starting pitcher has a 2.85 ERA in his last 5 starts, indicating consistent recent form, while web search reveals he has increased his fastball velocity by 2 MPH.`
`[CATEGORY: weather] Web search reveals 15-20 mph winds blowing out to center field tonight at Wrigley Field, potentially impacting fly balls and total runs.`

**IMPORTANT**: DO NOT include any closing message, question, or call to action at the end. Your response should be a direct list of insights in the specified format.

---

**Proposed Enhancements for `generate_dynamic_intro` Prompt (within `intelligent_professor_lock_insights.py`):**

This prompt needs to guide the AI to create a professional and engaging introduction that sets the tone for the daily insights, without using forced gambling slang.

**Current Prompt Snippet:**

```
Professor Lock, you just completed your research and found some valuable insights. Write a brief, professional greeting for your users.

Keep it under 50 words. Reference that you completed research but avoid gambling slang and promises.

AVOID: "locks", "bankroll", "cash", "juice", "grind", "money", betting promises
USE: Professional, analytical language

Examples:
- "Hey team! Just finished analyzing today's games and found some interesting data points worth reviewing."
- "What's up! Completed the research on today's slate and discovered some valuable statistical trends."
...
```

**Proposed Enhancements for `generate_dynamic_intro` Prompt:**

```
Professor Lock, you have just concluded your comprehensive daily research into the MLB slate. Craft a concise, professional, and engaging introductory message for your users. This message should set an analytical tone and invite users to explore the insights you've uncovered.

**KEY REQUIREMENTS:**
*   **Length:** Keep it under 50 words.
*   **Tone:** Professional, informative, and slightly authoritative, reflecting your persona as Professor Lock.
*   **Content:** Briefly mention the completion of your research and the availability of new insights. Hint at the depth of analysis without giving away specifics.
*   **Strictly AVOID:** Any gambling slang (e.g., "locks," "bankroll," "cash," "juice," "grind," "money"), direct betting recommendations, or promises of guaranteed wins. Also avoid overly casual or informal greetings.
*   **Focus:** Emphasize data, analysis, and informed decision-making.

**Examples of Desired Tone and Content:**
-   "Good morning, sports enthusiasts. My daily research into today's MLB matchups is complete, and I've uncovered several key analytical insights for your review."
-   "Greetings. I've just finalized a thorough examination of today's baseball slate, and the resulting data-driven insights are now ready to be explored."
-   "Attention, sharp minds. Professor Lock has concluded the daily deep dive into MLB statistics, presenting you with a fresh perspective on today's games."

Write ONE brief, professional greeting. Do not include any closing remarks or questions.
```

These enhanced prompts aim to provide clearer instructions to the AI models, emphasize the strategic use of the StatMuse API and web search, and guide the AI towards generating more sophisticated, data-driven, and disciplined outputs. By explicitly defining the tools' capabilities and setting strict guidelines for output, the AI can better understand its role and deliver higher-quality results.


## 6. Conclusion

The custom StatMuse API server is a powerful asset for the Parley app, providing crucial sports data to its AI systems. By implementing the proposed enhancements in scraping logic, caching, error handling, and data extraction, the server can become even more robust and efficient. Furthermore, optimizing the system prompts for `teams.py`, `props.py`, and `intelligent_professor_lock_insights.py` will enable the AI models to fully leverage the server's capabilities, leading to more accurate predictions and insightful analyses. The combination of a refined data source and intelligently prompted AI models will significantly elevate the Parley app's performance and user value.



